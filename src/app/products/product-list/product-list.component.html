<div class="container-xl pt-3">
  <section class="mb-3">
    <input
      type="button"
      class="btn btn-sm btn-info text-capitalize d-none d-md-block"
      routerLink="/products"
      value="more products"
    />
    <input
      type="button"
      class="btn btn-block btn-info text-capitalize d-md-none"
      routerLink="/products"
      value="more products"
    />
  </section>
  <ng-container *ngIf="sortedProducts$ | async as products; else notSubscribed">
    <div class="row mb-3">
      <div class="col">
        <hr />
      </div>
      <div class="col">
        <ng-container *ngIf="productType$ | async as type; else defaultTitle">
          <h1 class="font-weight-bold text-center text-capitalize">
            {{ type }}
          </h1>
        </ng-container>
        <ng-template #defaultTitle>
          <h1 class="font-weight-bold text-center text-capitalize">
            {{ pageTitle }}
          </h1>
        </ng-template>
      </div>
      <div class="col">
        <hr />
      </div>
    </div>
    <form class="my-2" novalidate [formGroup]="filterForm" autocomplete="off">
      <div class="form-row">
        <div class="col-lg-6 order-1">
          <div class="input-group mt-2 mt-lg-0">
            <div class="input-group-prepend">
              <span
                class="input-group-text bg-secondary text-white"
                id="basic-addon1"
                >Search</span
              >
            </div>
            <input
              type="text"
              id="search"
              formControlName="search"
              class="form-control"
              placeholder="By Name, Brand or Code"
              aria-describedby="basic-addon1"
            />
          </div>
        </div>
        <div class="col-lg-6 order-lg-12">
          <div class="form-row">
            <div class="col-sm">
              <div class="input-group">
                <div class="input-group-prepend">
                  <span
                    class="input-group-text bg-secondary text-white"
                    id="basic-addon1"
                    >Sort</span
                  >
                </div>
                <select
                  class="form-control custom-select"
                  formControlName="sort"
                >
                  <option [value]="0">- None -</option>
                  <optgroup label="Product Name">
                    <option [value]="1">A - Z</option>
                    <option [value]="2">Z - A</option>
                  </optgroup>
                  <optgroup label="Price">
                    <option [value]="3">Low - High</option>
                    <option [value]="4">High - Low</option>
                  </optgroup>
                  <optgroup label="Rating">
                    <option [value]="5">High - Low</option>
                    <option [value]="6">Low - High</option>
                  </optgroup>
                </select>
              </div>
            </div>
            <ng-container *ngIf="brands$ | async as brands">
              <div class="col-sm order-sm-first">
                <div class="input-group mt-2 mt-sm-0">
                  <div class="input-group-prepend">
                    <span
                      class="input-group-text bg-secondary text-white"
                      id="basic-addon1"
                      >Brand</span
                    >
                  </div>
                  <select
                    class="form-control custom-select"
                    formControlName="brand"
                  >
                    <option [value]="0">- All -</option>
                    <option *ngFor="let b of brands" [value]="b.id">
                      {{ b.name }}
                    </option>
                  </select>
                </div>
              </div>
            </ng-container>
            <!-- <div class="col-5">
                <div class="input-group">
                  <select
                    class="form-control custom-select"
                    formControlName="pageSize"
                  >
                    <option [value]="4">4 items per page</option>
                    <option [value]="6">6 items per page</option>
                    <option [value]="8">8 items per page</option>
                  </select>
                </div>
              </div> -->
          </div>
        </div>
      </div>
    </form>
    <div
      *ngIf="isFiltering$ | async"
      class="spinner-border loadingSpinner text-danger"
      role="status"
    >
      <span class="sr-only">Loading...</span>
    </div>
    <ng-container *ngIf="products.length; else noProducts">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="thead-dark">
            <tr class="text-uppercase d-none d-md-table-row">
              <!-- <th scope="col" class="d-none d-md-table-cell">#</th> -->
              <th scope="col">
                <svg
                  width="1.35em"
                  height="1.35em"
                  viewBox="0 0 16 16"
                  class="bi bi-card-image"
                  fill="currentColor"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    fill-rule="evenodd"
                    d="M14.5 3h-13a.5.5 0 0 0-.5.5v9c0 .013 0 .027.002.04V12l2.646-2.354a.5.5 0 0 1 .63-.062l2.66 1.773 3.71-3.71a.5.5 0 0 1 .577-.094L15 9.499V3.5a.5.5 0 0 0-.5-.5zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-13zm4.502 3.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"
                  />
                </svg>
              </th>
              <th scope="col">Product</th>
              <th scope="col">Brand</th>
              <th scope="col">Code</th>
              <th scope="col">Rating</th>
              <th scope="col">Price</th>
            </tr>
          </thead>
          <tbody>
            <ng-container
              *ngFor="
                let p of products
                  | slice
                    : (page - 1) * pageSize
                    : (page - 1) * pageSize + pageSize
              "
            >
              <tr
                (click)="scrollToTop()"
                [routerLink]="['../', p.type, p.id]"
                [queryParams]="{
                  id: filterForm.get('brand').value,
                  p: page,
                  sort: filterForm.get('sort').value,
                  search: filterForm.get('search').value
                }"
              >
                <!-- <th scope="row" class="d-none d-md-table-cell">{{ p.id }}</th> -->
                <td id="productImg" scope="row">
                  <img
                    class="img-fluid"
                    [src]="p.imageUrls ? p.imageUrls[0] : p.imageUrl"
                    [title]="p.name"
                  />
                  <div
                    class="d-flex flex-column justify-content-center align-items-center d-sm-none mt-3"
                  >
                    <p>{{ p.brand }}: {{ p.name }}</p>
                    <p>{{ p.price | currency }}</p>
                    <ngb-rating
                      class="star"
                      [(rate)]="p.starRating"
                      [readonly]="true"
                      [max]="5"
                    ></ngb-rating>
                  </div>
                </td>
                <td scope="row" class="d-none d-sm-table-cell">
                  <ngb-highlight
                    [result]="p.name"
                    [term]="filterForm.get('search').value"
                    [highlightClass]="['bg-info', 'text-light']"
                  ></ngb-highlight>
                </td>
                <td scope="row" class="d-none d-sm-table-cell">
                  <ngb-highlight
                    [result]="p.brand"
                    [term]="filterForm.get('search').value"
                    [highlightClass]="['bg-info', 'text-light']"
                  ></ngb-highlight>
                </td>
                <td scope="row" class="d-none d-sm-table-cell">
                  <ngb-highlight
                    [result]="p.code | lowercase | convertToSpaces: '-'"
                    [term]="filterForm.get('search').value"
                    [highlightClass]="['bg-info', 'text-light']"
                  ></ngb-highlight>
                </td>
                <td scope="row" class="d-none d-sm-table-cell">
                  <ngb-rating
                    class="star"
                    [(rate)]="p.starRating"
                    [readonly]="true"
                    [max]="5"
                  ></ngb-rating>
                </td>

                <td scope="row" class="d-none d-sm-table-cell">
                  {{ p.price | currency }}
                </td>
              </tr>
            </ng-container>
          </tbody>
          <caption>
            Showing
            <strong>{{
              products.length > pageSize ? pageSize : products.length
            }}</strong>
            of
            <strong>
              {{ products.length }}
            </strong>
          </caption>
        </table>
      </div>
    </ng-container>
    <ng-template #noProducts>
      <ngb-alert [dismissible]="false" type="danger" class="text-center">
        <span class="mr-1">No products found!</span>
        <input
          type="button"
          value="clear filters"
          role="alert"
          class="btn btn-secondary btn-sm text-capitalize"
          (click)="clearFilters()"
        />
      </ngb-alert>
    </ng-template>
    <div *ngIf="products.length > 5" class="d-flex justify-content-between">
      <div>
        <button class="btn btn-outline-primary" (click)="scrollToTop()">
          Back to top
        </button>
      </div>
      <ngb-pagination
        *ngIf="products.length > pageSize"
        [collectionSize]="products.length"
        [(page)]="page"
        [pageSize]="pageSize"
      >
      </ngb-pagination>
    </div>
  </ng-container>
  <ng-template #notSubscribed>
    <ng-container *ngIf="error$ | async as error; else loading"
      ><h1 class="text-danger text-center text-capitalize mb-3">
        Retrievel Error
      </h1>
      <ngb-alert [dismissible]="false" type="danger" class="text-center">
        <span>{{ error }}</span>
      </ngb-alert>
    </ng-container>

    <ng-template #loading>
      <div class="d-flex justify-content-center m-3">
        <div class="spinner-border text-info" id="contentSpinner" role="status">
          <span class="sr-only">Loading... </span>
        </div>
      </div>
    </ng-template>
  </ng-template>
</div>
